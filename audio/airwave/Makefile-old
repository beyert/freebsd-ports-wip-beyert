# Created by: Timothy Beyer <beyert@cs.ucr.edu>

PORTNAME=	airwave
PORTVERSION=	20200715
CATEGORIES=	audio

MAINTAINER=	beyert@cs.ucr.edu
COMMENT=	Wine based bridge to use Windows 32/64-bit VST 2.4 plugins

LICENSE=	MIT
LICENSE_FILE=	${WRKSRC}/LICENSE

ONLY_FOR_ARCHS=	amd64 i386

BUILD_DEPENDS=	${LOCALBASE}/include/vst3sdk/vstbus.h:audio/vst3sdk \
	${LOCALBASE}/lib/libwine.so:emulators/wine
#	${LOCALBASE}/lib/wine/xaudio2_0.dll.so:emulators/wine
#	${LOCALBASE}/lib/wine/${WINEARCH}-unix/xaudio2_0.dll.so:emulators/wine-devel
#LIB_DEPENDS=	${LOCALBASE}/lib/wine/xaudio2_0.dll.so:emulators/wine
#LIB_DEPENDS=	lib/wine/${WINEARCH}-unix/xaudio2_0.dll.so:emulators/wine-devel
LIB_DEPENDS=	libwine.so:emulators/wine
RUN_DEPENDS=	${LOCALBASE}/lib/wine/xaudio2_0.dll.so:emulators/wine
#RUN_DEPENDS=	${LOCALBASE}/lib/libwine.so:emulators/wine

USES=	compiler:c++11-lib cmake qt:5

#OPTIONS_DEFINE=>...VST3 VST2
#OPTIONS_DEFAULT=>..VST3

#VST3_DESC=>VST3 plugin support
#VST2_DESC=>VST2 plugin support (restricted redistribution)

#.if ${PORT_OPTIONS:MVST3}
#BUILD_DEPENDS+=>...${LOCALBASE}/include/vst3sdk/vstbus.h:audio/vst3sdk
#CMAKE_ARGS+=>..-DVSTSDK_PATH=${LOCALBASE}/include/vst3sdk
#.endif
CMAKE_ARGS+=>...-DVSTSDK_PATH=${LOCALBASE}/include/vst3sdk \
	-DVSTSDK_INCLUDE_DIR=${VSTSDK_INCLUDE_DIR}
#.if ${PORT_OPTIONS:MVST2}
#CMAKE_ARGS+=>..-DVSTSDK_INCLUDE_DIR=${VSTSDK_INCLUDE_DIR}
#.endif
#	-DCMAKE_CURRENT_BINARY_DIR=${LOCALBASE}/lib/${PORTNAME}
#cmake -DCMAKE_BUILD_TYPE="Release" \
#	-DCMAKE_INSTALL_PREFIX=/usr/local/lib/airwave \
#>..-DVSTSDK_PATH=${LOCALBASE}/include/vst3sdk \
#>..-DVSTSDK_INCLUDE_DIR=${VSTSDK_INCLUDE_DIR}

.include <bsd.port.options.mk>

.if ${ARCH} == "amd64"
CMAKE_ARGS+=	-DDISABLE_32BIT=yes -DPLATFORM_64BIT=yes
PLIST_SUB+=	WINE32="@comment " WINE64=""
VERSION=	64
.else
CMAKE_ARGS+=	-DDISABLE_64BIT=yes -DPLATFORM_32BIT=yes
PLIST_SUB+=	WINE32="" WINE64="@comment "
VERSION=	32
.endif

USE_GITHUB=	yes
GH_ACCOUNT=	psycha0s
GH_PROJECT=	${PORTNAME}
GH_TAGNAME=	e44976c

post-patch:
	@${REINPLACE_CMD} -e 's|-Wall|-I/usr/src/sys/compat -Wall|' \
		-e 's|$${PROJECT_NAME}-plugin|$${PROJECT_NAME}-plugin${VERSION}|g' \
		${WRKSRC}/CMakeLists.txt
#	@${REINPLACE_CMD} -e 's|$${PLUGIN_BASENAME}|$${PLUGIN_BASENAME}${VERSION}|g' \
#		-e 's|DESTINATION bin|DESTINATION lib/${PORTNAME}|' \
#		${WRKSRC}/src/plugin/CMakeLists.txt
	@${REINPLACE_CMD} -e 's|DESTINATION bin|DESTINATION lib/${PORTNAME}|' \
		${WRKSRC}/src/plugin/CMakeLists.txt
	@${REINPLACE_CMD} \
		-e 's|TARGET_NAME $${PROJECT_NAME}-manager|TARGET_NAME $${PROJECT_NAME}-manager${VERSION}|g' \
		-e 's|DESTINATION bin|DESTINATION lib/${PORTNAME}|' \
		${WRKSRC}/src/manager/CMakeLists.txt
	@${REINPLACE_CMD} 's|/bin|/lib/${PORTNAME}|g' \
		${WRKSRC}/src/common/storage.cpp
.if ${ARCH} == "amd64"
	@${REINPLACE_CMD} 's|"wine"|"wine${VERSION}"|g' \
		${WRKSRC}/src/common/storage.cpp
.endif
	@${CP} -p ${WRKSRC}/src/manager/${PORTNAME}-manager.desktop.in \
		${WRKSRC}/src/manager/${PORTNAME}-manager${VERSION}.desktop.in
	@${CP} -p ${WRKSRC}/src/manager/resources/${PORTNAME}-manager.png \
		${WRKSRC}/src/manager/resources/${PORTNAME}-manager${VERSION}.png

post-install:
#	@${MKDIR} ${STAGEDIR}${LOCALBASE}/lib/airwave
.if ${ARCH} == "amd64"
	@cd ${STAGEDIR}${LOCALBASE}/lib && \
		${LN} -s airwave/airwave-plugin64.so libairwave-plugin64.so && \
		${LN} -s airwave/airwave-host-64.exe.so libairwave-host-64.exe.so
	@cd ${STAGEDIR}${LOCALBASE}/bin && \
		${LN} -s ../lib/airwave/airwave-host-64.exe airwave-host-64.exe && \
		${LN} -s ../lib/airwave/airwave-manager64 airwave-manager64
.else
	@cd ${STAGEDIR}${LOCALBASE}/lib && \
		${LN} -s airwave/airwave-plugin32.so libairwave-plugin32.so && \
		${LN} -s airwave/airwave-host-64.exe.so libairwave-host-32.exe.so
	@cd ${STAGEDIR}${LOCALBASE}/bin && \
		${LN} -s ../lib/airwave/airwave-host-32.exe airwave-host-32.exe && \
		${LN} -s ../lib/airwave/airwave-manager32 airwave-manager32
.endif

.include <bsd.port.mk>
